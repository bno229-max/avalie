<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SaaS Avaliação V8.0 - Multilojas</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, query, orderBy, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDysVQvQqWkkDY5rb4XlyoRUelyvtokvN0",
            authDomain: "avalie-73150.firebaseapp.com",
            projectId: "avalie-73150",
            storageBucket: "avalie-73150.firebasestorage.app",
            messagingSenderId: "583366208074",
            appId: "1:583366208074:web:0f34f89ecc76d3c12154b3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentUser = null;
        // Captura o ID da loja pela URL (ex: site.com/?id=LOJA123)
        const urlParams = new URLSearchParams(window.location.search);
        const lojaIdDaUrl = urlParams.get('id');

        // --- VERIFICAÇÃO INICIAL ---
        if (!lojaIdDaUrl && !window.location.hash.includes('admin')) {
            document.body.innerHTML = `<div style="text-align:center; padding:50px;"><h2>QR Code Inválido</h2><p>Por favor, utilize o QR Code da mesa.</p></div>`;
        }

        // --- AUTHENTICATION ---
        window.handleLogin = async () => {
            const email = document.getElementById('admEmail').value;
            const pass = document.getElementById('admPass').value;
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (error) {
                alert("Acesso negado: E-mail ou senha incorretos.");
            }
        };

        window.handleLogout = () => signOut(auth).then(() => location.reload());

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('client-app').style.display = 'none';
                document.getElementById('admin-app').style.display = 'block';
                renderAdmin();
            }
        });

        // --- SALVAR AVALIAÇÃO (MODO MULTILOJA) ---
        window.submitReview = async (e) => {
            e.preventDefault();
            const n1 = parseInt(document.querySelector('input[name="rate_dish"]:checked').value);
            const n2 = parseInt(document.querySelector('input[name="rate_drink"]:checked').value);
            const n3 = parseInt(document.querySelector('input[name="rate_service"]:checked').value);
            const n4 = parseInt(document.querySelector('input[name="rate_struct"]:checked').value);
            const wantC = document.querySelector('input[name="want_coupon"]:checked').value === "Sim";
            const coupon = wantC ? "VIP-"+Math.floor(1000+Math.random()*9000) : null;
            const now = new Date();
            
            const entry = {
                lojaID: lojaIdDaUrl, // Vínculo com a loja
                table: document.getElementById('tableNum').value,
                value: parseFloat(document.getElementById('spendValue').value) || 0,
                avg: (n1+n2+n3+n4)/4, n1, n2, n3, n4,
                name: document.getElementById('cName').value || "Anônimo",
                phone: document.getElementById('cPhone').value || "-",
                date: now.toISOString().split('T')[0],
                timestamp: now.getTime(),
                coupon: coupon, used: false,
                expiryRaw: now.getTime() + (5 * 24 * 60 * 60 * 1000)
            };

            try {
                await addDoc(collection(db, "reviews"), entry);
                mostrarSucesso(coupon, new Date(entry.expiryRaw));
            } catch (err) { alert("Erro ao enviar avaliação."); }
        };

        // --- RENDERIZAR PAINEL (FILTRADO POR LOJA) ---
        window.renderAdmin = async () => {
            if(!currentUser) return;
            // Só busca as avaliações onde o lojaID é o UID do dono logado
            const q = query(
                collection(db, "reviews"), 
                where("lojaID", "==", currentUser.uid),
                orderBy("timestamp", "desc")
            );
            
            const querySnapshot = await getDocs(q);
            const cL = document.getElementById('couponList'), rL = document.getElementById('reviewsList');
            cL.innerHTML=''; rL.innerHTML='';
            
            let count=0, sAvg=0, sCash=0;
            const start = document.getElementById('dateStart').value;
            const end = document.getElementById('dateEnd').value;

            querySnapshot.forEach((docSnap) => {
                const item = docSnap.data();
                if(start && item.date < start) return;
                if(end && item.date > end) return;

                count++; sAvg += item.avg; sCash += item.value;
                const id = docSnap.id;
                
                if(item.coupon) {
                    cL.innerHTML += `<tr>
                        <td class="col-cliente">${item.name}</td>
                        <td class="col-cupom"><b>${item.coupon}</b></td>
                        <td class="col-expira">${new Date(item.expiryRaw).toLocaleDateString('pt-BR')}</td>
                        <td class="col-acao"><button class="${item.used?'btn-validado':'btn-baixar'}" onclick="${item.used?'':'darBaixa(\''+id+'\')'}">${item.used?'OK':'BAIXAR'}</button></td>
                    </tr>`;
                }
                // ... (restante do código de renderização do histórico permanece igual)
            });
            document.getElementById('cardTotal').textContent = count;
            document.getElementById('cardAvg').textContent = count > 0 ? (sAvg/count).toFixed(1) : "0.0";
            document.getElementById('cardTicket').textContent = (count > 0 ? (sCash/count) : 0).toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
            
            // Atualiza o link do QR Code automático para a loja logada
            const meuLink = window.location.origin + window.location.pathname + "?id=" + currentUser.uid;
            document.getElementById('meu-id-display').innerText = currentUser.uid;
            document.getElementById('qr-link').value = meuLink;
        };

        window.darBaixa = async (id) => {
            await updateDoc(doc(db, "reviews", id), { used: true });
            renderAdmin();
        };

    </script>

    <style>
        /* MANTÉM O MESMO CSS DA V6.8/7.0 */
        :root { --primary: #FF6B00; --dark: #2D3436; --light: #F4F7F6; --success: #2ecc71; --danger: #e74c3c; --gray: #dfe6e9; --star-gold: #FFD700; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--light); margin: 0; color: var(--dark); }
        .client-view, .admin-view { max-width: 500px; margin: 0 auto; padding: 20px; background: #fff; min-height: 100vh; }
        .admin-view { max-width: 1000px; display: none; }
        .client-input { width: 100%; padding: 15px; margin: 10px 0; border-radius: 10px; border: 1px solid #ddd; box-sizing: border-box; }
        .btn-finalizar { background: var(--primary); color: #fff; border: none; padding: 20px; width: 100%; border-radius: 50px; font-weight: 800; cursor: pointer; transition: 0.3s; }
        .btn-finalizar:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(255,107,0,0.4); }
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin: 20px 0; }
        .metric-card { background: #f9f9f9; padding: 15px; border-radius: 10px; text-align: center; }
        .metric-card span { display: block; font-size: 1.5rem; font-weight: 800; color: var(--primary); }
        .coupon-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        .coupon-table td, .coupon-table th { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
        .btn-baixar { background: var(--danger); color: #fff; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
        .btn-validado { background: var(--success); color: #fff; border: none; padding: 5px 10px; border-radius: 5px; opacity: 0.5; }
    </style>
</head>
<body>

    <div id="client-app" class="client-view">
        <h2 style="color:var(--primary); text-align:center;">Sua Opinião Vale Muito!</h2>
        <form onsubmit="submitReview(event)">
            <input type="number" id="tableNum" placeholder="Nº da Mesa" class="client-input" required>
            <input type="number" id="spendValue" placeholder="Valor Gasto (Opcional)" class="client-input" step="0.01">
            
            <p style="font-weight:bold; text-align:center;">Como estava o Prato?</p>
            <div style="display:flex; justify-content:center; gap:10px; margin-bottom:20px;">
                <input type="radio" name="rate_dish" value="5" required> 5★ 
                <input type="radio" name="rate_dish" value="4"> 4★ 
                <input type="radio" name="rate_dish" value="3"> 3★ 
                <input type="radio" name="rate_dish" value="2"> 2★ 
                <input type="radio" name="rate_dish" value="1"> 1★
            </div>
            <div style="padding: 15px; border: 1px solid #eee; border-radius:10px;">
                <label><input type="radio" name="want_coupon" value="Sim" onclick="toggleC(true)"> Quero Cupom!</label>
                <label><input type="radio" name="want_coupon" value="Não" onclick="toggleC(false)" checked> Não</label>
                <div id="c-fields" style="display:none; margin-top:10px;">
                    <input type="text" id="cName" placeholder="Seu Nome" class="client-input">
                    <input type="tel" id="cPhone" placeholder="WhatsApp" class="client-input">
                </div>
            </div>
            <button type="submit" class="btn-finalizar" style="margin-top:20px;">ENVIAR AVALIAÇÃO</button>
        </form>
        <div id="success-screen" style="display:none; text-align:center; padding:20px;">
            <h2 style="color:var(--success);">Enviado!</h2>
            <div id="coupon-box" style="display:none; border:2px dashed var(--primary); padding:20px;">
                <p>Seu Cupom:</p>
                <h1 id="generatedCode"></h1>
            </div>
        </div>
    </div>

    <div id="admin-app" class="admin-view">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h1>Painel da Loja</h1>
            <button onclick="handleLogout()" style="padding:10px;">Sair</button>
        </div>
        <p>ID da sua Loja: <span id="meu-id-display" style="font-weight:bold; color:var(--primary);"></span></p>

        <div class="dashboard-grid">
            <div class="metric-card"><span id="cardAvg">0.0</span><small>Média</small></div>
            <div class="metric-card"><span id="cardTotal">0</span><small>Votos</small></div>
            <div class="metric-card"><span id="cardTicket">R$ 0</span><small>Ticket</small></div>
        </div>

        <div style="margin-bottom:30px;">
            <h3>Gerador de QR Code</h3>
            <input type="text" id="qr-link" class="client-input" readonly>
            <button onclick="generateQR()" class="btn-finalizar" style="padding:10px;">Gerar QR Code desta Loja</button>
            <div id="qrcode" style="margin-top:20px; display:flex; justify-content:center;"></div>
        </div>

        <h3>Cupons Ativos</h3>
        <table class="coupon-table">
            <thead><tr><th>Cliente</th><th>Cupom</th><th>Expira</th><th>Ação</th></tr></thead>
            <tbody id="couponList"></tbody>
        </table>

        <h3>Histórico</h3>
        <div id="reviewsList"></div>
    </div>

    <div id="login-screen" style="position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; display:none; flex-direction:column; align-items:center; justify-content:center; padding:20px; box-sizing:border-box;">
        <h2>Acesso Lojista</h2>
        <input type="email" id="admEmail" placeholder="E-mail" class="client-input" style="max-width:300px;">
        <input type="password" id="admPass" placeholder="Senha" class="client-input" style="max-width:300px;">
        <button onclick="handleLogin()" class="btn-finalizar" style="max-width:300px;">Entrar no Painel</button>
    </div>

    <p style="text-align:center; color:#ccc; margin-top:20px; cursor:pointer;" onclick="document.getElementById('login-screen').style.display='flex'">Acesso Administrativo</p>

    <script>
        function toggleC(s) { document.getElementById('c-fields').style.display = s ? 'block' : 'none'; }
        function mostrarSucesso(coupon, expDate) {
            document.querySelector('form').style.display='none';
            document.getElementById('success-screen').style.display='block';
            if(coupon){
                document.getElementById('coupon-box').style.display='block';
                document.getElementById('generatedCode').innerText = coupon;
            }
        }
        function generateQR() {
            const link = document.getElementById('qr-link').value;
            document.getElementById("qrcode").innerHTML="";
            new QRCode(document.getElementById("qrcode"), { text: link, width: 200, height: 200 });
        }
    </script>
</body>
</html>